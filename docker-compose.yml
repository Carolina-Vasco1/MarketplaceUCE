services:
  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    ports:
      - "8000:8000"
    environment:
      JWT_SECRET: ${JWT_SECRET}
      JWT_ALG: HS256
      FRONTEND_ORIGIN: ${FRONTEND_ORIGIN}
      AUTH_URL: http://auth-service:8001
      PRODUCT_URL: http://product-service:8002
      ORDER_URL: http://order-service:8003
      PAYMENT_URL: http://payment-service:8004
      NOTIF_URL: http://notification-service:8005
    depends_on:
      - auth-service
      - product-service
      - order-service
      - payment-service
      - notification-service

  auth-service:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile
    environment:
      POSTGRES_URL: postgresql+asyncpg://auth:auth@postgres:5432/auth_db
      JWT_SECRET: ${JWT_SECRET}
      JWT_ALG: HS256
      JWT_EXPIRES_MIN: 1440
      REDIS_URL: redis://redis:6379/0
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM: ${SMTP_FROM}
    depends_on:
      - postgres
      - redis

  product-service:
    build:
      context: .
      dockerfile: services/product-service/Dockerfile
    environment:
      MONGO_URL: mongodb://mongo:27017
      MONGO_DB: catalog_db
      REDIS_URL: redis://redis:6379/0
      UPLOAD_DIR: /app/uploads
      PUBLIC_BASE_URL: http://localhost:8000
    volumes:
      - product_uploads:/app/uploads
    depends_on:
      - mongo
      - redis

  order-service:
    build:
      context: .
      dockerfile: services/order-service/Dockerfile
    environment:
      POSTGRES_URL: postgresql+asyncpg://order:order@postgres:5432/order_db
      KAFKA_BOOTSTRAP: kafka:9092
    depends_on:
      - postgres
      - kafka

  payment-service:
    build:
      context: .
      dockerfile: services/payment-service/Dockerfile
    environment:
      KAFKA_BOOTSTRAP: kafka:9092
      PAYPAL_BASE_URL: ${PAYPAL_BASE_URL}
      PAYPAL_CLIENT_ID: ${PAYPAL_CLIENT_ID}
      PAYPAL_CLIENT_SECRET: ${PAYPAL_CLIENT_SECRET}
      PAYPAL_WEBHOOK_ID: ${PAYPAL_WEBHOOK_ID}
    depends_on:
      - kafka

  notification-service:
    build:
      context: .
      dockerfile: services/notification-service/Dockerfile
    environment:
      KAFKA_BOOTSTRAP: kafka:9092
    depends_on:
      - kafka

  postgres:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./infra/postgres/init:/docker-entrypoint-initdb.d
    command: ["postgres", "-c", "max_connections=200"]

  mongo:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongodata:/data/db

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"

  prometheus:
    image: prom/prometheus:v2.55.0
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    depends_on:
      - gateway
      - auth-service
      - product-service
      - order-service
      - payment-service
      - notification-service

  grafana:
    image: grafana/grafana:11.2.0
    ports:
      - "3000:3000"
    volumes:
      - ./infra/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus

volumes:
  pgdata:
  mongodata:
  product_uploads:
